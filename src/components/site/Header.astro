---
import { getConfig } from "../../lib/cms/config";
import { getDatabase } from "../../lib/cms/database";
import { i18n } from "../../lib/i18n";
import LanguageSwitcher from "../LanguageSwitcher.astro";

const config = getConfig();
const db = await getDatabase();
const menus = await db.getMenus();

const currentLocale = await i18n.getLocale(Astro.request);
const t = await i18n.getT(currentLocale);

// Try to find a menu named "Main Menu" or "Header Menu"
const headerMenu =
  menus.find(
    (m) =>
      m.name.toLowerCase() === "main menu" ||
      m.name.toLowerCase() === "header menu" ||
      m.name.toLowerCase() === "navigation",
  ) || menus[0];

let navItems = [
  { label: t("Home"), href: "/", target: "_self" },
  { label: t("Blog"), href: "/blog", target: "_self" },
  { label: t("About"), href: "/about", target: "_self" },
  { label: t("Admin"), href: "/admin", target: "_self" },
];

if (headerMenu) {
  try {
    const items =
      typeof headerMenu.items === "string"
        ? JSON.parse(headerMenu.items)
        : headerMenu.items;

    if (Array.isArray(items) && items.length > 0) {
      navItems = items.map((item: any) => ({
        label: item.label,
        href: item.url,
        target: item.target,
      }));
    }
  } catch (e) {
    console.error("Failed to parse menu items:", e);
  }
}
---

<header
  class="sticky top-0 z-50 border-b border-[var(--theme-border)] bg-[rgba(var(--theme-background-rgb),0.8)] backdrop-blur-xl"
>
  <div class="max-w-6xl mx-auto px-4 sm:px-6">
    <nav class="flex items-center justify-between h-16">
      <a href="/" class="flex items-center gap-3 group">
        <div
          class="w-10 h-10 rounded-xl bg-gradient-to-br from-[var(--theme-primary)] to-[var(--theme-accent)] flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
        </div>
        <span
          class="text-xl font-bold text-[var(--theme-text)] group-hover:text-[var(--theme-primary)] transition-colors"
        >
          {config.siteName}
        </span>
      </a>

      <ul class="hidden md:flex items-center gap-1">
        {
          navItems.map((item) => (
            <li>
              <a
                href={item.href}
                target={item.target || "_self"}
                class="px-4 py-2 rounded-lg text-[var(--theme-text)] opacity-60 hover:opacity-100 hover:bg-[rgba(var(--theme-text-rgb),0.05)] transition-all duration-200"
              >
                {item.label}
              </a>
            </li>
          ))
        }
      </ul>

      <div class="flex items-center gap-3">
        <LanguageSwitcher />
        <a href="/admin" class="btn btn-primary text-sm">
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          {t("New Post")}
        </a>
      </div>
    </nav>
  </div>
</header>
