---
import AdminLayout from "@layouts/AdminLayout.astro";
import { getDatabase } from "@lib/cms/database";

const db = await getDatabase();
const forms = await db.getContactForms();
const submissions = await db.getFormSubmissions();

// Parse submission data
const formattedSubmissions = submissions.map((sub) => ({
  ...sub,
  data: typeof sub.data === "string" ? JSON.parse(sub.data) : sub.data,
}));
---

<AdminLayout title="Form Submissions">
  <div class="space-y-6">
    <div class="flex items-center gap-4 mb-6">
      <a href="/admin/forms" class="text-slate-400 hover:text-slate-100">
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>
      </a>
      <div>
        <p class="text-slate-400">{submissions.length} submissions</p>
      </div>
    </div>

    <!-- Filter -->
    <div class="card">
      <div class="flex items-center gap-4">
        <label class="text-slate-300 text-sm">Filter by form:</label>
        <select id="form-filter" class="input">
          <option value="">All Forms</option>
          {forms.map((form) => <option value={form.id}>{form.title}</option>)}
        </select>
      </div>
    </div>

    <!-- Submissions Table -->
    <div class="card overflow-hidden p-0">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-800/50">
            <tr>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase"
                >Status</th
              >
              <th
                class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase"
                >Form</th
              >
              <th
                class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase"
                >Data</th
              >
              <th
                class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase"
                >Date</th
              >
              <th
                class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase"
                >Actions</th
              >
            </tr>
          </thead>
          <tbody id="submissions-tbody" class="divide-y divide-slate-800">
            {
              formattedSubmissions.map((sub) => (
                <tr
                  class="submission-row hover:bg-slate-800/30"
                  data-form-id={sub.form_id}
                  data-id={sub.id}
                >
                  <td class="px-4 py-3">
                    <span
                      class={`px-2 py-1 rounded text-xs font-medium ${
                        sub.status === "new"
                          ? "bg-emerald-500/20 text-emerald-400"
                          : sub.status === "read"
                            ? "bg-slate-500/20 text-slate-400"
                            : sub.status === "replied"
                              ? "bg-cyan-500/20 text-cyan-400"
                              : sub.status === "spam"
                                ? "bg-red-500/20 text-red-400"
                                : "bg-slate-500/20 text-slate-400"
                      }`}
                    >
                      {sub.status}
                    </span>
                  </td>
                  <td class="px-4 py-3 text-slate-300">{sub.form_title}</td>
                  <td class="px-4 py-3">
                    <div class="max-w-md">
                      {Object.entries(sub.data)
                        .slice(0, 3)
                        .map(([key, value]) => (
                          <p class="text-sm text-slate-400 truncate">
                            <span class="text-slate-500">{key}:</span>{" "}
                            {String(value)}
                          </p>
                        ))}
                      {Object.keys(sub.data).length > 3 && (
                        <p class="text-xs text-slate-500">
                          +{Object.keys(sub.data).length - 3} more fields
                        </p>
                      )}
                    </div>
                  </td>
                  <td class="px-4 py-3 text-sm text-slate-400">
                    {sub.created_at
                      ? new Date(sub.created_at).toLocaleString()
                      : "N/A"}
                  </td>
                  <td class="px-4 py-3">
                    <div class="flex items-center gap-1">
                      <button
                        class="view-btn p-1.5 rounded hover:bg-slate-800 text-slate-400 hover:text-slate-100 transition-colors"
                        data-submission={JSON.stringify(sub)}
                      >
                        <svg
                          class="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                          />
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                          />
                        </svg>
                      </button>
                      <select
                        class="status-select text-xs bg-transparent border border-slate-700 rounded px-2 py-1 text-slate-400"
                        data-id={sub.id}
                      >
                        <option value="new" selected={sub.status === "new"}>
                          New
                        </option>
                        <option value="read" selected={sub.status === "read"}>
                          Read
                        </option>
                        <option
                          value="replied"
                          selected={sub.status === "replied"}
                        >
                          Replied
                        </option>
                        <option value="spam" selected={sub.status === "spam"}>
                          Spam
                        </option>
                      </select>
                      <button
                        class="delete-btn p-1.5 rounded hover:bg-red-500/10 text-slate-400 hover:text-red-400 transition-colors"
                        data-id={sub.id}
                      >
                        <svg
                          class="w-4 h-4"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                          />
                        </svg>
                      </button>
                    </div>
                  </td>
                </tr>
              ))
            }
          </tbody>
        </table>
      </div>
    </div>

    {
      submissions.length === 0 && (
        <div class="card text-center py-16">
          <div class="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mx-auto mb-4">
            <svg
              class="w-8 h-8 text-slate-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
              />
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-slate-100 mb-2">
            No submissions yet
          </h3>
          <p class="text-slate-400">
            Submissions will appear here when users fill out your forms
          </p>
        </div>
      )
    }
  </div>

  <!-- View Submission Modal -->
  <dialog
    id="view-modal"
    class="bg-slate-900 rounded-xl p-6 border border-slate-800 backdrop:bg-slate-950/80 w-full max-w-lg"
  >
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-slate-100">Submission Details</h3>
      <button id="close-view" class="text-slate-400 hover:text-slate-100">
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div id="submission-details" class="space-y-3 max-h-96 overflow-y-auto">
      <!-- Details will be populated -->
    </div>
    <div class="flex justify-end pt-4 mt-4 border-t border-slate-800">
      <button
        id="close-view-btn"
        class="btn bg-slate-800 text-slate-300 hover:bg-slate-700">Close</button
      >
    </div>
  </dialog>

  <div
    id="toast"
    class="fixed bottom-4 right-4 bg-emerald-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"
  >
  </div>
</AdminLayout>

<script>
  const viewModal = document.getElementById("view-modal") as HTMLDialogElement;
  const toast = document.getElementById("toast") as HTMLElement;
  const submissionDetails = document.getElementById(
    "submission-details",
  ) as HTMLElement;

  function showToast(message: string, isError = false) {
    toast.textContent = message;
    toast.className = `fixed bottom-4 right-4 ${isError ? "bg-red-500" : "bg-emerald-500"} text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300`;
    setTimeout(() => {
      toast.className = `fixed bottom-4 right-4 ${isError ? "bg-red-500" : "bg-emerald-500"} text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300`;
    }, 3000);
  }

  // Filter submissions by form
  document.getElementById("form-filter")?.addEventListener("change", (e) => {
    const formId = (e.target as HTMLSelectElement).value;
    document.querySelectorAll(".submission-row").forEach((row) => {
      const rowFormId = (row as HTMLElement).dataset.formId;
      (row as HTMLElement).style.display =
        !formId || rowFormId === formId ? "" : "none";
    });
  });

  // View submission details
  document.querySelectorAll(".view-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const sub = JSON.parse((btn as HTMLElement).dataset.submission || "{}");
      submissionDetails.innerHTML = `
        <div class="bg-slate-800/50 rounded p-3">
          <p class="text-xs text-slate-500 mb-1">Form</p>
          <p class="text-slate-200">${sub.form_title}</p>
        </div>
        <div class="bg-slate-800/50 rounded p-3">
          <p class="text-xs text-slate-500 mb-1">Date</p>
          <p class="text-slate-200">${new Date(sub.created_at).toLocaleString()}</p>
        </div>
        ${Object.entries(sub.data)
          .map(
            ([key, value]) => `
          <div class="bg-slate-800/50 rounded p-3">
            <p class="text-xs text-slate-500 mb-1">${key}</p>
            <p class="text-slate-200 whitespace-pre-wrap">${value}</p>
          </div>
        `,
          )
          .join("")}
        ${
          sub.ip_address
            ? `
          <div class="bg-slate-800/50 rounded p-3">
            <p class="text-xs text-slate-500 mb-1">IP Address</p>
            <p class="text-slate-200">${sub.ip_address}</p>
          </div>
        `
            : ""
        }
      `;
      viewModal.showModal();
    });
  });

  document
    .getElementById("close-view")
    ?.addEventListener("click", () => viewModal.close());
  document
    .getElementById("close-view-btn")
    ?.addEventListener("click", () => viewModal.close());

  // Update submission status
  document.querySelectorAll(".status-select").forEach((select) => {
    select.addEventListener("change", async (e) => {
      const id = (e.target as HTMLSelectElement).dataset.id;
      const status = (e.target as HTMLSelectElement).value;

      try {
        const res = await fetch("/api/forms/submissions", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, status }),
        });

        const result = await res.json();
        if (result.success) {
          showToast("Status updated!");
        } else {
          showToast(result.error || "Failed to update", true);
        }
      } catch (err) {
        showToast("An error occurred", true);
      }
    });
  });

  // Delete submission
  document.querySelectorAll(".delete-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      if (!confirm("Are you sure you want to delete this submission?")) return;

      const id = (btn as HTMLElement).dataset.id;

      try {
        const res = await fetch("/api/forms/submissions", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id }),
        });

        const result = await res.json();
        if (result.success) {
          showToast("Submission deleted!");
          setTimeout(() => window.location.reload(), 500);
        } else {
          showToast(result.error || "Failed to delete", true);
        }
      } catch (err) {
        showToast("An error occurred", true);
      }
    });
  });
</script>
