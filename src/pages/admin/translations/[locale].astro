---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import { i18n } from "../../../lib/i18n";

const { locale } = Astro.params;

if (!locale) {
  return Astro.redirect("/admin/translations");
}

const allKeys = await i18n.scanProject();
const translations = await i18n.loadLocale(locale);

// Group keys by status
const stats = {
  total: allKeys.length,
  translated: allKeys.filter((key) => !!translations[key]).length,
  untranslated: allKeys.filter((key) => !translations[key]).length,
};
---

<AdminLayout title={`Translate to ${locale.toUpperCase()}`}>
  <div class="space-y-6">
    <div class="flex justify-between items-center">
      <div class="flex items-center gap-4">
        <a
          href="/admin/translations"
          class="p-2 text-slate-400 hover:text-slate-100 bg-slate-800 rounded-lg transition-colors"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
        </a>
        <div>
          <h2 class="text-2xl font-bold text-slate-100">
            Editing {locale.toUpperCase()}
          </h2>
          <p class="text-slate-400">
            {stats.translated} of {stats.total} strings translated ({
              Math.round((stats.translated / stats.total) * 100)
            }%)
          </p>
        </div>
      </div>
      <div class="flex gap-3">
        <button
          id="save-btn"
          class="px-6 py-2 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold rounded-lg transition-colors flex items-center gap-2"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 13l4 4L19 7"></path>
          </svg>
          Save Changes
        </button>
      </div>
    </div>

    <div
      class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden"
    >
      <div class="p-4 border-b border-slate-800 bg-slate-800/30 flex gap-4">
        <div class="relative flex-1">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </span>
          <input
            type="text"
            id="search-strings"
            placeholder="Search strings..."
            class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-10 pr-4 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500/50"
          />
        </div>
        <select
          id="filter-status"
          class="bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-500/50"
        >
          <option value="all">All Strings</option>
          <option value="translated">Translated</option>
          <option value="untranslated">Untranslated</option>
        </select>
      </div>

      <div class="max-h-[calc(100vh-300px)] overflow-y-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr
              class="bg-slate-800/50 border-b border-slate-800 sticky top-0 z-10"
            >
              <th
                class="px-6 py-3 text-xs font-semibold text-slate-400 uppercase tracking-wider w-1/2"
                >Source Text</th
              >
              <th
                class="px-6 py-3 text-xs font-semibold text-slate-400 uppercase tracking-wider w-1/2"
                >{locale.toUpperCase()} Translation</th
              >
            </tr>
          </thead>
          <tbody id="strings-table-body" class="divide-y divide-slate-800">
            {
              allKeys.map((key) => (
                <tr
                  class="string-row hover:bg-slate-800/30 transition-colors"
                  data-status={
                    translations[key] ? "translated" : "untranslated"
                  }
                >
                  <td class="px-6 py-4 align-top">
                    <div class="text-slate-300 font-medium break-words source-text">
                      {key}
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <textarea
                      class="translation-input w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/50 transition-all min-h-[40px] resize-y"
                      data-key={key}
                      placeholder={`Enter translation for "${key}"...`}
                    >
                      {translations[key] || ""}
                    </textarea>
                  </td>
                </tr>
              ))
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div
    id="toast"
    class="fixed bottom-6 right-6 transform translate-y-20 opacity-0 transition-all duration-300 z-50"
  >
    <div
      class="bg-emerald-500 text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3"
    >
      <svg
        class="w-5 h-5"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M5 13l4 4L19 7"></path>
      </svg>
      <span id="toast-message">Changes saved successfully!</span>
    </div>
  </div>
</AdminLayout>

<script define:vars={{ locale }}>
  const saveBtn = document.getElementById("save-btn");
  const searchInput = document.getElementById("search-strings");
  const filterStatus = document.getElementById("filter-status");
  const rows = document.querySelectorAll(".string-row");
  const toast = document.getElementById("toast");
  const toastMessage = document.getElementById("toast-message");

  function showToast(message, type = "success") {
    toastMessage.textContent = message;
    toast.classList.remove("translate-y-20", "opacity-0");
    setTimeout(() => {
      toast.classList.add("translate-y-20", "opacity-0");
    }, 3000);
  }

  // Filter logic
  function filterStrings() {
    const searchTerm = searchInput.value.toLowerCase();
    const status = filterStatus.value;

    rows.forEach((row) => {
      const sourceText = row
        .querySelector(".source-text")
        .textContent.toLowerCase();
      const translation = row
        .querySelector(".translation-input")
        .value.toLowerCase();
      const rowStatus = row.dataset.status;

      const matchesSearch =
        sourceText.includes(searchTerm) || translation.includes(searchTerm);
      const matchesStatus = status === "all" || status === rowStatus;

      if (matchesSearch && matchesStatus) {
        row.classList.remove("hidden");
      } else {
        row.classList.add("hidden");
      }
    });
  }

  searchInput?.addEventListener("input", filterStrings);
  filterStatus?.addEventListener("change", filterStrings);

  // Save logic
  saveBtn?.addEventListener("click", async () => {
    saveBtn.classList.add("animate-pulse");
    saveBtn.setAttribute("disabled", "true");

    const data = {};
    document.querySelectorAll(".translation-input").forEach((input) => {
      const key = input.dataset.key;
      const value = input.value.trim();
      if (value) {
        data[key] = value;
      }
    });

    try {
      const response = await fetch("/api/translations", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "saveLocale", code: locale, data }),
      });

      if (response.ok) {
        showToast("Translations saved successfully!");
        // Update row statuses
        document.querySelectorAll(".translation-input").forEach((input) => {
          const row = input.closest(".string-row");
          row.dataset.status = input.value.trim()
            ? "translated"
            : "untranslated";
        });
      } else {
        showToast("Failed to save translations", "error");
      }
    } catch (error) {
      console.error(error);
      showToast("Error saving translations", "error");
    } finally {
      saveBtn.classList.remove("animate-pulse");
      saveBtn.removeAttribute("disabled");
    }
  });

  // Auto-resize textareas
  document.querySelectorAll(".translation-input").forEach((textarea) => {
    textarea.addEventListener("input", function () {
      this.style.height = "auto";
      this.style.height = this.scrollHeight + "px";
    });
    // Initial resize
    if (textarea.value) {
      textarea.style.height = textarea.scrollHeight + "px";
    }
  });
</script>
