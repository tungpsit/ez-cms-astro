---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getDatabase } from '../../lib/cms/database';

const db = await getDatabase();
const categoriesData = await db.getCategories();
const postsData = await db.getPosts();

const categories = categoriesData.map(cat => ({
  id: cat.id,
  data: {
    name: cat.name,
    slug: cat.slug,
    description: cat.description,
    color: cat.color,
  }
}));

const categoriesWithCount = categories.map(cat => ({
  ...cat,
  postCount: postsData.filter(p => p.category === cat.data.name).length
}));
---

<AdminLayout title="Categories">
  <div class="space-y-6">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-slate-400">{categories.length} categories</p>
      </div>
      <button id="add-category-btn" class="btn btn-primary">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        New Category
      </button>
    </div>

    <div id="categories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {categoriesWithCount.map(category => (
        <div class="card group hover:border-emerald-500/30 transition-all" data-id={category.id}>
          <div class="flex items-start justify-between mb-3">
            <div 
              class="w-10 h-10 rounded-lg flex items-center justify-center"
              style={`background-color: ${category.data.color}20`}
            >
              <svg class="w-5 h-5" fill="none" stroke={category.data.color} viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
              </svg>
            </div>
            <div class="flex items-center gap-1">
              <button 
                class="edit-btn p-1.5 rounded hover:bg-slate-800 text-slate-400 hover:text-slate-100 transition-colors"
                data-id={category.id}
                data-name={category.data.name}
                data-description={category.data.description || ''}
                data-color={category.data.color}
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
              <button 
                class="delete-btn p-1.5 rounded hover:bg-red-500/10 text-slate-400 hover:text-red-400 transition-colors"
                data-id={category.id}
                data-name={category.data.name}
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </div>
          
          <h3 class="font-semibold text-slate-100 mb-1">{category.data.name}</h3>
          
          {category.data.description && (
            <p class="text-sm text-slate-400 mb-3">{category.data.description}</p>
          )}
          
          <div class="flex items-center gap-3 text-xs text-slate-500">
            <span class="flex items-center gap-1">
              <span class="w-3 h-3 rounded-full" style={`background-color: ${category.data.color}`}></span>
              {category.data.color}
            </span>
            <span>â€¢</span>
            <span>{category.postCount} posts</span>
          </div>
        </div>
      ))}
    </div>

    {categories.length === 0 && (
      <div class="card text-center py-16">
        <div class="w-16 h-16 rounded-full bg-slate-800 flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-slate-100 mb-2">No categories yet</h3>
        <p class="text-slate-400 mb-4">Create categories to organize your content</p>
        <button id="empty-add-btn" class="btn btn-primary">Create Category</button>
      </div>
    )}
  </div>

  <dialog id="category-modal" class="bg-slate-900 rounded-xl p-6 border border-slate-800 backdrop:bg-slate-950/80 w-full max-w-md">
    <h3 id="modal-title" class="text-lg font-semibold text-slate-100 mb-4">New Category</h3>
    <form id="category-form" class="space-y-4">
      <input type="hidden" name="id" id="category-id" />
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-2">Name</label>
        <input type="text" name="name" id="category-name" class="input w-full" required />
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-2">Description</label>
        <textarea name="description" id="category-description" class="input w-full" rows="2"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-300 mb-2">Color</label>
        <div class="flex gap-2">
          <input type="color" name="color" id="category-color" class="w-12 h-10 rounded border-0 cursor-pointer bg-transparent" value="#0ea5e9" />
          <input type="text" id="category-color-text" class="input flex-1" value="#0ea5e9" />
        </div>
      </div>
      <div class="flex gap-3 justify-end pt-4">
        <button type="button" id="cancel-modal" class="btn bg-slate-800 text-slate-300 hover:bg-slate-700">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </dialog>

  <dialog id="delete-modal" class="bg-slate-900 rounded-xl p-6 border border-slate-800 backdrop:bg-slate-950/80">
    <h3 class="text-lg font-semibold text-slate-100 mb-2">Delete Category</h3>
    <p class="text-slate-400 mb-6">Are you sure you want to delete "<span id="delete-name"></span>"? This action cannot be undone.</p>
    <div class="flex gap-3 justify-end">
      <button id="cancel-delete" class="btn bg-slate-800 text-slate-300 hover:bg-slate-700">Cancel</button>
      <button id="confirm-delete" class="btn bg-red-500 text-white hover:bg-red-600">Delete</button>
    </div>
  </dialog>

  <div id="toast" class="fixed bottom-4 right-4 bg-emerald-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"></div>
</AdminLayout>

<script>
  const modal = document.getElementById('category-modal') as HTMLDialogElement;
  const deleteModal = document.getElementById('delete-modal') as HTMLDialogElement;
  const form = document.getElementById('category-form') as HTMLFormElement;
  const toast = document.getElementById('toast') as HTMLElement;
  
  const modalTitle = document.getElementById('modal-title') as HTMLElement;
  const idInput = document.getElementById('category-id') as HTMLInputElement;
  const nameInput = document.getElementById('category-name') as HTMLInputElement;
  const descInput = document.getElementById('category-description') as HTMLTextAreaElement;
  const colorInput = document.getElementById('category-color') as HTMLInputElement;
  const colorText = document.getElementById('category-color-text') as HTMLInputElement;
  const deleteName = document.getElementById('delete-name') as HTMLElement;
  
  let currentDeleteId = '';
  let isEditing = false;

  function showToast(message: string, isError = false) {
    toast.textContent = message;
    toast.className = `fixed bottom-4 right-4 ${isError ? 'bg-red-500' : 'bg-emerald-500'} text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-0 opacity-100 transition-all duration-300`;
    setTimeout(() => {
      toast.className = `fixed bottom-4 right-4 ${isError ? 'bg-red-500' : 'bg-emerald-500'} text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300`;
    }, 3000);
  }

  function openAddModal() {
    isEditing = false;
    modalTitle.textContent = 'New Category';
    idInput.value = '';
    nameInput.value = '';
    descInput.value = '';
    colorInput.value = '#0ea5e9';
    colorText.value = '#0ea5e9';
    modal.showModal();
  }

  function openEditModal(id: string, name: string, description: string, color: string) {
    isEditing = true;
    modalTitle.textContent = 'Edit Category';
    idInput.value = id;
    nameInput.value = name;
    descInput.value = description;
    colorInput.value = color;
    colorText.value = color;
    modal.showModal();
  }

  colorInput.addEventListener('input', () => {
    colorText.value = colorInput.value;
  });

  colorText.addEventListener('input', () => {
    if (/^#[0-9A-Fa-f]{6}$/.test(colorText.value)) {
      colorInput.value = colorText.value;
    }
  });

  document.getElementById('add-category-btn')?.addEventListener('click', openAddModal);
  document.getElementById('empty-add-btn')?.addEventListener('click', openAddModal);
  document.getElementById('cancel-modal')?.addEventListener('click', () => modal.close());
  document.getElementById('cancel-delete')?.addEventListener('click', () => deleteModal.close());

  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const el = btn as HTMLElement;
      openEditModal(
        el.dataset.id || '',
        el.dataset.name || '',
        el.dataset.description || '',
        el.dataset.color || '#0ea5e9'
      );
    });
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const el = btn as HTMLElement;
      currentDeleteId = el.dataset.id || '';
      deleteName.textContent = el.dataset.name || '';
      deleteModal.showModal();
    });
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
      name: nameInput.value,
      description: descInput.value,
      color: colorInput.value,
    };
    
    try {
      const url = isEditing ? `/api/categories/${idInput.value}` : '/api/categories';
      const method = isEditing ? 'PUT' : 'POST';
      
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      
      const result = await res.json();
      
      if (result.success) {
        showToast(isEditing ? 'Category updated!' : 'Category created!');
        modal.close();
        setTimeout(() => {
          window.location.href = '/admin/categories?t=' + Date.now();
        }, 1000);
      } else {
        showToast(result.error || 'Failed to save', true);
      }
    } catch (err) {
      showToast('An error occurred', true);
    }
  });

  document.getElementById('confirm-delete')?.addEventListener('click', async () => {
    try {
      const res = await fetch(`/api/categories/${currentDeleteId}`, { method: 'DELETE' });
      const result = await res.json();
      
      if (result.success) {
        showToast('Category deleted!');
        deleteModal.close();
        setTimeout(() => {
          window.location.href = '/admin/categories?t=' + Date.now();
        }, 1000);
      } else {
        showToast(result.error || 'Failed to delete', true);
      }
    } catch (err) {
      showToast('An error occurred', true);
    }
  });
</script>